# Plugin H264 开发计划 - 基于技术验证版

## 开发概述

基于2025年8月29日完成的技术验证结果，制定分阶段开发计划。所有技术风险已在验证阶段识别和解决。

### 开发原则
- **验证优先**: 所有开发基于验证通过的API和配置
- **增量开发**: 小步快跑，每个版本都可独立测试
- **质量保证**: 每阶段完成后进行完整测试
- **文档同步**: 代码和文档同步更新

## Phase 1: 核心解码器实现 (1周)

### 1.1 目标
实现基础的H.264视频和AAC音频解码功能，无UI集成。

### 1.2 任务清单

#### Day 1-2: 项目结构搭建
- [ ] 创建完整的目录结构
- [ ] 配置CMakeLists.txt (基于验证结果)
- [ ] 集成第三方库 (OpenH264 2.6.0, FDK-AAC 2.0.3, MiniMP4)
- [ ] 设置编译环境和CI/CD

**验证点**: 空项目可以成功编译和链接所有库

#### Day 3-4: 解码器封装实现
- [ ] 实现H264Decoder类 (基于OpenH264 2.6.0 API)
  - [ ] 使用验证通过的WelsCreateDecoder/WelsDestroyDecoder
  - [ ] 实现验证通过的参数设置 (DECODER_OPTION_ERROR_CON_IDC)
  - [ ] 添加基于验证结果的错误处理
- [ ] 实现AACDecoder类 (基于FDK-AAC 2.0.3 API)  
  - [ ] 使用验证通过的aacDecoder_Open/aacDecoder_Close
  - [ ] 实现验证通过的参数配置
  - [ ] 添加基于验证结果的错误处理
- [ ] 实现MP4Demuxer类 (基于MiniMP4 API)
  - [ ] 使用验证通过的MP4D_open/MP4D_close
  - [ ] 实现SPS/PPS提取 (MP4D_read_sps/MP4D_read_pps)
  - [ ] 添加基于验证结果的错误处理

**验证点**: 每个解码器可以独立初始化、解码测试数据、正确释放资源

#### Day 5-6: 核心管理类实现
- [ ] 实现DecoderManager类
  - [ ] 解码器生命周期管理
  - [ ] 基于验证结果的内存管理
  - [ ] 统一错误处理
- [ ] 实现H264Movie类
  - [ ] 文件加载和解析
  - [ ] 解码器协调
  - [ ] 状态管理

**验证点**: 可以打开MP4文件，提取视频和音频流，进行基础解码

#### Day 7: Phase 1测试和验收
- [ ] 单元测试 (基于验证结果)
  - [ ] 解码器初始化测试
  - [ ] 错误处理测试 (基于验证中发现的错误码)
  - [ ] 内存泄漏测试
- [ ] 集成测试
  - [ ] 完整解码流水线测试
  - [ ] 多格式MP4文件测试
  - [ ] 性能基准测试

**交付物**:
- 可独立运行的解码器库
- 完整的单元测试套件
- Phase 1验收报告

## Phase 2: 音视频同步和缓冲 (1周)

### 2.1 目标
实现精确的音视频同步机制和高效的缓冲管理。

### 2.2 任务清单

#### Day 8-9: 时间轴和同步实现
- [ ] 实现Timeline类
  - [ ] 基于MP4时间戳的时间轴
  - [ ] 播放速度控制
  - [ ] 暂停/恢复逻辑
- [ ] 实现AVSynchronizer类
  - [ ] 音视频同步算法
  - [ ] 基于验证结果的缓冲策略
  - [ ] 丢帧和补偿机制

**验证点**: 音视频同步误差<40ms，支持暂停/恢复/快进

#### Day 10-11: 缓冲管理实现
- [ ] 实现MemoryPool类 (基于验证的内存限制)
  - [ ] 预分配视频帧缓冲 (基于1920x1080 YUV420)
  - [ ] 预分配音频帧缓冲 (基于立体声16bit)
  - [ ] 内存使用监控
- [ ] 实现CircularBuffer模板
  - [ ] 无锁循环缓冲区
  - [ ] 生产者-消费者模式
  - [ ] 缓冲区状态监控

**验证点**: 内存使用稳定在200KB以内，无内存泄漏

#### Day 12-13: 多线程架构实现
- [ ] 实现ThreadManager类
  - [ ] 解码线程 (视频/音频分离)
  - [ ] 缓冲管理线程
  - [ ] 线程安全的消息队列
- [ ] 线程同步机制
  - [ ] 基于condition_variable的帧同步
  - [ ] 原子操作的状态管理
  - [ ] 异常安全的线程终止

**验证点**: 多线程稳定运行，CPU使用率合理，无死锁

#### Day 14: Phase 2测试和验收
- [ ] 性能测试
  - [ ] 1080p@30fps流畅播放
  - [ ] CPU和内存使用率测试
  - [ ] 长时间播放稳定性测试
- [ ] 同步精度测试
  - [ ] 音视频同步精度测量
  - [ ] 快进/快退功能测试
  - [ ] 多格式兼容性测试

**交付物**:
- 具备完整音视频同步的播放引擎
- 性能测试报告
- Phase 2验收报告

## Phase 3: Solar2D集成和Lua绑定 (1周)

### 3.1 目标
集成Solar2D纹理系统和OpenAL音频，实现完整的Lua API。

### 3.2 任务清单

#### Day 15-16: Solar2D纹理集成
- [ ] 实现TextureRenderer类
  - [ ] YUV到RGB转换 (GPU加速优先)
  - [ ] Solar2D纹理对象创建和更新
  - [ ] 纹理缓存和回收
- [ ] 实现Solar2D显示对象
  - [ ] MovieRect (矩形显示对象)
  - [ ] MovieTexture (纹理对象)
  - [ ] 缩放、旋转、透明度支持

**验证点**: 视频帧可以正确显示在Solar2D场景中

#### Day 17-18: OpenAL音频集成  
- [ ] 实现AudioOutput类
  - [ ] PCM音频数据到OpenAL缓冲区
  - [ ] 音频流播放控制
  - [ ] 音量控制和静音
- [ ] 音频设备管理
  - [ ] 设备初始化和释放
  - [ ] 错误处理和设备切换
  - [ ] 多声道支持

**验证点**: 音频可以正常播放，支持暂停/恢复/音量控制

#### Day 19-20: Lua API实现
- [ ] 实现LuaBinding.cpp
  - [ ] 所有plugin_movie兼容的API
  - [ ] 错误处理和异常转换
  - [ ] 内存管理和GC集成
- [ ] 实现plugin_h264.lua
  - [ ] newMovieTexture API
  - [ ] newMovieRect API  
  - [ ] 事件处理和回调
  - [ ] 错误报告和调试信息

**验证点**: Lua API与现有plugin_movie完全兼容

#### Day 21: Phase 3测试和验收
- [ ] Solar2D集成测试
  - [ ] 在实际Solar2D项目中测试
  - [ ] 多平台兼容性验证
  - [ ] 性能影响评估
- [ ] API兼容性测试
  - [ ] 与现有plugin_movie的API对比测试
  - [ ] 边界情况和错误处理测试
  - [ ] 内存使用和性能测试

**交付物**:
- 完整的Solar2D插件
- API兼容性测试报告  
- Phase 3验收报告

## Phase 4: 跨平台适配和优化 (1周)

### 4.1 目标
适配iOS、Android平台，进行性能优化和发布准备。

### 4.2 任务清单

#### Day 22-23: iOS平台适配
- [ ] iOS编译配置
  - [ ] Xcode项目配置
  - [ ] ARM64架构适配
  - [ ] iOS库依赖处理
- [ ] iOS特定优化
  - [ ] Metal纹理渲染优化
  - [ ] AVAudioSession集成
  - [ ] 内存警告处理

**验证点**: 在iOS设备上流畅播放1080p视频

#### Day 24-25: Android平台适配  
- [ ] Android编译配置
  - [ ] Gradle构建脚本
  - [ ] NDK和JNI配置
  - [ ] 多架构支持 (arm64-v8a, armeabi-v7a)
- [ ] Android特定优化
  - [ ] OpenGL ES纹理渲染
  - [ ] AudioTrack音频输出
  - [ ] 权限和生命周期管理

**验证点**: 在Android设备上流畅播放1080p视频

#### Day 26-27: 性能优化
- [ ] 解码性能优化
  - [ ] SIMD指令优化 (基于验证结果)
  - [ ] 多线程负载均衡
  - [ ] 缓存友好的数据结构
- [ ] 内存优化
  - [ ] 内存池调优
  - [ ] GC压力减少
  - [ ] 资源预加载和释放策略
- [ ] 渲染优化
  - [ ] GPU纹理上传优化
  - [ ] 渲染管道优化
  - [ ] 帧率稳定性改进

**验证点**: 所有平台达到性能目标，内存使用稳定

#### Day 28: Phase 4测试和最终验收
- [ ] 跨平台测试
  - [ ] iOS/Android/macOS/Windows全平台测试
  - [ ] 不同设备和分辨率测试
  - [ ] 极限条件测试
- [ ] 性能基准测试
  - [ ] 与原plugin_movie性能对比
  - [ ] 与其他H.264播放器对比
  - [ ] 资源使用效率评估
- [ ] 最终质量检查
  - [ ] 代码审查和重构
  - [ ] 文档完整性检查
  - [ ] 许可证合规最终确认

**交付物**:
- 全平台就绪的插件
- 性能对比报告
- 最终验收和发布文档

## 质量保证计划

### 持续集成 (CI/CD)
```yaml
# .github/workflows/ci.yml
name: Plugin H264 CI
on: [push, pull_request]

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - name: Build third-party libraries
        run: |
          # 基于验证结果的构建命令
          cd third_party/openh264 && make
          cd ../fdk-aac && mkdir build && cd build && cmake .. && make
      - name: Build plugin
        run: |
          mkdir build && cd build
          cmake .. && make
      - name: Run tests
        run: |
          cd build && ctest --verbose
      - name: Memory leak check
        run: valgrind --leak-check=full ./build/test_suite
```

### 测试策略

#### 单元测试覆盖率目标
- [ ] 解码器类: 95%覆盖率
- [ ] 错误处理: 100%覆盖率  
- [ ] 内存管理: 90%覆盖率
- [ ] API绑定: 85%覆盖率

#### 集成测试场景
- [ ] 标准MP4文件播放
- [ ] 损坏文件处理
- [ ] 网络流播放
- [ ] 大文件播放 (>4GB)
- [ ] 极低内存环境
- [ ] 多实例同时播放

#### 性能测试指标
- [ ] 1080p@30fps: CPU使用率 < 30%
- [ ] 内存占用: 基线 + 200KB
- [ ] 启动延迟: < 500ms
- [ ] 音视频同步: 误差 < 40ms

## 风险管理计划

### 技术风险 (基于验证结果)
| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| API兼容性问题 | 低 | 中 | 基于验证结果设计，持续测试 |
| 性能不达标 | 低 | 高 | 基于验证的性能基线，早期benchmark |
| 内存泄漏 | 中 | 高 | RAII设计，自动化内存检查 |
| 平台兼容性 | 中 | 中 | 增量平台适配，早期测试 |

### 进度风险
| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 开发延期 | 中 | 中 | 缓冲时间，任务优先级调整 |
| 测试不充分 | 低 | 高 | 自动化测试，持续集成 |
| 文档滞后 | 高 | 低 | 文档驱动开发，模板化 |

## 成功标准

### Phase 1成功标准
- [ ] 所有解码器可以独立工作
- [ ] 内存使用稳定在验证范围内
- [ ] 单元测试覆盖率>90%

### Phase 2成功标准  
- [ ] 音视频同步误差<40ms
- [ ] 支持1080p@30fps流畅播放
- [ ] 多线程稳定运行无死锁

### Phase 3成功标准
- [ ] 与plugin_movie API 100%兼容
- [ ] Solar2D集成无性能回退
- [ ] 错误处理健壮性验证

### Phase 4成功标准
- [ ] 全平台编译和运行成功
- [ ] 性能指标满足预期
- [ ] 许可证合规确认

### 最终成功标准
- [ ] 库大小 < 4MB (验证目标3.6MB)
- [ ] 内存占用 < 5MB (包含缓冲区)
- [ ] 启动时间 < 500ms
- [ ] CPU使用率 < 30% (1080p播放)
- [ ] 0 known bugs in critical path
- [ ] 100% API compatibility with plugin_movie

## 时间线总览

```
Week 1 (Phase 1): 核心解码器实现
├── Day 1-2: 项目搭建  
├── Day 3-4: 解码器封装
├── Day 5-6: 管理类实现
└── Day 7: 测试验收

Week 2 (Phase 2): 音视频同步
├── Day 8-9: 时间轴同步
├── Day 10-11: 缓冲管理  
├── Day 12-13: 多线程架构
└── Day 14: 测试验收

Week 3 (Phase 3): Solar2D集成
├── Day 15-16: 纹理集成
├── Day 17-18: 音频集成
├── Day 19-20: Lua API
└── Day 21: 测试验收

Week 4 (Phase 4): 跨平台优化
├── Day 22-23: iOS适配
├── Day 24-25: Android适配
├── Day 26-27: 性能优化
└── Day 28: 最终验收
```

## 团队协作

### 开发环境要求
- CMake 3.10+
- C++11编译器
- Git版本控制
- 基于验证环境的依赖库

### 代码规范
- Google C++ Style Guide
- 基于验证结果的错误处理模式
- RAII资源管理
- const-correctness

### 文档要求
- 每个类包含详细注释
- API文档自动生成
- README包含构建和使用说明
- 基于验证结果的troubleshooting guide

---

## 总结

本开发计划基于完整的技术验证结果，确保所有技术决策都有实际验证支撑。采用4周增量开发模式，每个阶段都有明确的交付物和成功标准。通过持续测试和质量保证，最终交付高质量、高性能、商用友好的H.264视频播放插件。